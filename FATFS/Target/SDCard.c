/**
  ******************************************************************************
  * @file     lib.c
  * @author   Auto-generated by STM32CubeIDE
  * @version  V1.0
  * @date     29/05/2025 12:33:58
  * @brief    Default under dev library file.
  ******************************************************************************
*/

/* Includes ------------------------------------------------------------------*/

#include "SDCard.h"

FATFS fs_sd;


/** Functions ----------------------------------------------------------------*/


FRESULT SD_Initialize(void)
{
	return f_mount(&fs_sd, "", 1);  // "" = default drive
}

bool RES_IsInserted(void)
{
	return SD_SPI_IsInserted();
}

FRESULT SD_GetInfo(uint32_t *totalMB, uint32_t *freeMB)
{
	FATFS *fs = &fs_sd;
    DWORD fre_clust, fre_sect, tot_sect;
    FRESULT res = f_getfree("", &fre_clust, &fs);

    if (res != FR_OK) return res;

    tot_sect = (fs->n_fatent - 2) * fs->csize;
    fre_sect = fre_clust * fs->csize;

    *totalMB = tot_sect / 2048; // sectors -> MB
    *freeMB  = fre_sect  / 2048;

    return res;
}

FRESULT SD_Deinitialize(void)
{
    return f_mount(NULL, "", 1); // Unmount
}

bool SD_SubmitJob(SD_Job_t *job, osMessageQId queueHandle)
{
    if(!job) return false;

    job->status = SD_JOB_PENDING;
    job->bytesTransferred = 0;
    return xQueueSend(queueHandle, &job, 0) == pdTRUE; // 0 = non-blocking enqueue
}
